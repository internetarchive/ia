<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link href="https://esm.archive.org/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
  <style>
    .btns {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      margin-top: 50px;
    }
    .btns .btn {
      margin:10px;
    }
  </style>
</head>

<body style="margin: 25px">
  <a style="position:absolute; bottom:25px; right:25px" href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API">
    File System Access API
  </a>


  <div class="card card-body bg-light">
    <center>
      <a id="download-item" class="btn btn-sm btn-primary">Download archive.org item:</a>
      <form>
        <input id="IAID" class="form-control" type="text" name="IAID" value="commute" style="max-width:25%"/>
      </form>
    </center>
  </div>

  <div class="btns">
    <a id="dir-sel" class="btn btn-sm btn-primary">Open Folder on your Computer</a>

    <a id="download-jpg" class="btn btn-sm btn-primary">Download an archive.org JPEG</a>

    <a id="new-file" class="btn btn-sm btn-primary">Make a new file</a>
  </div>
</body>


<script type="module">

// imported methods will use the File System Access API or a fallback implementation
import { fileSave } from 'https://unpkg.com/browser-fs-access'
import $ from 'https://esm.archive.org/jquery'


const log = console.log.bind(console)

const msg = (txt) => {
  const e = document.createElement('div')
  e.innerHTML = `<div class="card card-body bg-light">${txt}</div>`
  document.body.appendChild(e)
}


async function download_item() {
  const IAID = document.getElementById('IAID').value

  const dirHandle = await window.showDirectoryPicker();
  await dirHandle.requestPermission({ mode: "readwrite" });

  const mdapi = await (await fetch(`https://archive.org/metadata/${IAID}`)).json()
  const prefix = `https://archive.org/download/${IAID}/`
  log(mdapi)

  for (const fileobj of mdapi.files.sort()) {
    const file = fileobj.name
    msg(`downloading: [${IAID}] ${file}`)

    try {
      const data = await fetch(`${prefix}${file}`)
      const blob = await data.blob()
      const outfile = file.replace(/.*\//, '')
      log('WRITE TO', outfile)

      const fh = await dirHandle.getFileHandle(outfile, { create: true })

      const writable = await fh.createWritable()
      await writable.write(blob)
      await writable.close()
      continue

      await fileSave(blob, { fileName: outfile })
    } catch (e) {
      log('ERROR', e) // skip over CORS-restricted files for now
    }
  }
}


async function directory_selector() {
  const dir_ref = await self.showDirectoryPicker()
  if (dir_ref) {
    // read dir
    for await (const [name, entry] of dir_ref) {
      // entry is FileSystemFileHandle or FileSystemDirectoryHandle
      if (entry.kind == 'file') {
        msg(`file: ${name}`)
        log('file', { name, entry })

        const file = await entry.getFile()
        const fileData = await file.text()
        log({ fileData })



      } else {
        log('dir', { name, entry })
        msg(`dir: ${name}`)
      }
    }

    // Get a specific file
    const entry = await dir_ref.getFileHandle('index.html')
    log({ entry })
    const file = await entry.getFile()
    const fileData = await file.text()
    log({ fileData })

    // $('body').html(fileData)
  }
}


async function write_new_file() {
  const fh = await window.showSaveFilePicker({
    types: [{
      description: 'A JPEG',
      accept: {
        'image/jpeg': ['.jpg'],
      },
    }],
  })

  const data = await fetch('https://archive.org/download/stairs/stairs.jpg')
  const contents = await data.blob()
  // Create a FileSystemWritableFileStream to write to.
  const writable = await fh.createWritable()
  // Write the contents of the file to the stream.
  await writable.write(contents)
  // Close the file and write the contents to disk.
  await writable.close()
}


// Create a new file
let FH
async function get_new_file_handle() {
  const options = {
    types: [{
      description: 'A JPEG',
      accept: {
        'image/jpeg': ['.jpg'],
      },
    }],
  }
  FH = await window.showSaveFilePicker(options)
  return FH
}


document.getElementById('download-item').addEventListener('click', download_item)
document.getElementById('dir-sel').addEventListener('click', directory_selector)
document.getElementById('download-jpg').addEventListener('click', write_new_file)
document.getElementById('new-file').addEventListener('click', get_new_file_handle)

</script>
